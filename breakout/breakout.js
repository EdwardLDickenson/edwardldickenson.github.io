var levelOne = [{"dimensions":[600,600,40,20,80,20,2,5,6]},{"blocks":[{"type":1,"hits":1,"x":0,"y":0},{"type":1,"hits":1,"x":0,"y":20},{"type":1,"hits":1,"x":0,"y":40},{"type":1,"hits":1,"x":0,"y":60},{"type":1,"hits":1,"x":0,"y":80},{"type":1,"hits":1,"x":0,"y":100},{"type":1,"hits":1,"x":0,"y":120},{"type":1,"hits":1,"x":0,"y":140},{"type":1,"hits":1,"x":0,"y":160},{"type":1,"hits":1,"x":0,"y":180},{"type":1,"hits":1,"x":0,"y":200},{"type":1,"hits":1,"x":0,"y":220},{"type":1,"hits":1,"x":0,"y":240},{"type":1,"hits":1,"x":0,"y":260},{"type":1,"hits":1,"x":0,"y":280},{"type":1,"hits":1,"x":0,"y":300},{"type":1,"hits":1,"x":40,"y":300},{"type":1,"hits":1,"x":40,"y":280},{"type":1,"hits":1,"x":40,"y":260},{"type":1,"hits":1,"x":40,"y":220},{"type":1,"hits":1,"x":40,"y":160},{"type":1,"hits":1,"x":40,"y":80},{"type":1,"hits":1,"x":40,"y":0},{"type":1,"hits":1,"x":40,"y":20},{"type":1,"hits":1,"x":40,"y":40},{"type":1,"hits":1,"x":40,"y":60},{"type":1,"hits":1,"x":40,"y":120},{"type":1,"hits":1,"x":40,"y":140},{"type":1,"hits":1,"x":40,"y":100},{"type":1,"hits":1,"x":40,"y":180},{"type":1,"hits":1,"x":40,"y":200},{"type":1,"hits":1,"x":40,"y":240},{"type":1,"hits":1,"x":80,"y":300},{"type":1,"hits":1,"x":80,"y":280},{"type":1,"hits":1,"x":80,"y":260},{"type":1,"hits":1,"x":80,"y":240},{"type":1,"hits":1,"x":80,"y":220},{"type":1,"hits":1,"x":80,"y":200},{"type":1,"hits":1,"x":80,"y":180},{"type":1,"hits":1,"x":80,"y":160},{"type":1,"hits":1,"x":80,"y":140},{"type":1,"hits":1,"x":80,"y":120},{"type":1,"hits":1,"x":80,"y":100},{"type":1,"hits":1,"x":80,"y":80},{"type":1,"hits":1,"x":80,"y":60},{"type":1,"hits":1,"x":80,"y":40},{"type":1,"hits":1,"x":80,"y":20},{"type":1,"hits":1,"x":80,"y":0},{"type":1,"hits":1,"x":120,"y":0},{"type":1,"hits":1,"x":120,"y":40},{"type":1,"hits":1,"x":120,"y":80},{"type":1,"hits":1,"x":120,"y":140},{"type":1,"hits":1,"x":120,"y":180},{"type":1,"hits":1,"x":120,"y":220},{"type":1,"hits":1,"x":120,"y":240},{"type":1,"hits":1,"x":120,"y":280},{"type":1,"hits":1,"x":120,"y":300},{"type":1,"hits":1,"x":120,"y":260},{"type":1,"hits":1,"x":120,"y":200},{"type":1,"hits":1,"x":120,"y":160},{"type":1,"hits":1,"x":120,"y":120},{"type":1,"hits":1,"x":120,"y":100},{"type":1,"hits":1,"x":120,"y":60},{"type":1,"hits":1,"x":120,"y":20},{"type":1,"hits":1,"x":160,"y":0},{"type":1,"hits":1,"x":160,"y":20},{"type":1,"hits":1,"x":160,"y":40},{"type":1,"hits":1,"x":160,"y":60},{"type":1,"hits":1,"x":160,"y":80},{"type":1,"hits":1,"x":160,"y":100},{"type":1,"hits":1,"x":160,"y":120},{"type":1,"hits":1,"x":160,"y":140},{"type":1,"hits":1,"x":160,"y":160},{"type":1,"hits":1,"x":160,"y":180},{"type":1,"hits":1,"x":160,"y":200},{"type":1,"hits":1,"x":160,"y":220},{"type":1,"hits":1,"x":160,"y":240},{"type":1,"hits":1,"x":160,"y":260},{"type":1,"hits":1,"x":160,"y":280},{"type":1,"hits":1,"x":160,"y":300},{"type":1,"hits":1,"x":200,"y":300},{"type":1,"hits":1,"x":200,"y":280},{"type":1,"hits":1,"x":200,"y":260},{"type":1,"hits":1,"x":200,"y":240},{"type":1,"hits":1,"x":200,"y":220},{"type":1,"hits":1,"x":200,"y":200},{"type":1,"hits":1,"x":200,"y":180},{"type":1,"hits":1,"x":200,"y":160},{"type":1,"hits":1,"x":200,"y":140},{"type":1,"hits":1,"x":200,"y":120},{"type":1,"hits":1,"x":200,"y":100},{"type":1,"hits":1,"x":200,"y":80},{"type":1,"hits":1,"x":200,"y":60},{"type":1,"hits":1,"x":200,"y":40},{"type":1,"hits":1,"x":200,"y":0},{"type":1,"hits":1,"x":200,"y":20},{"type":1,"hits":1,"x":240,"y":20},{"type":1,"hits":1,"x":240,"y":80},{"type":1,"hits":1,"x":240,"y":100},{"type":1,"hits":1,"x":240,"y":120},{"type":1,"hits":1,"x":280,"y":180},{"type":1,"hits":1,"x":280,"y":220},{"type":1,"hits":1,"x":280,"y":260},{"type":1,"hits":1,"x":240,"y":300},{"type":1,"hits":1,"x":240,"y":280},{"type":1,"hits":1,"x":240,"y":260},{"type":1,"hits":1,"x":240,"y":240},{"type":1,"hits":1,"x":240,"y":220},{"type":1,"hits":1,"x":240,"y":200},{"type":1,"hits":1,"x":240,"y":180},{"type":1,"hits":1,"x":240,"y":160},{"type":1,"hits":1,"x":240,"y":140},{"type":1,"hits":1,"x":240,"y":40},{"type":1,"hits":1,"x":240,"y":60},{"type":1,"hits":1,"x":240,"y":0},{"type":1,"hits":1,"x":280,"y":0},{"type":1,"hits":1,"x":280,"y":20},{"type":1,"hits":1,"x":280,"y":40},{"type":1,"hits":1,"x":280,"y":80},{"type":1,"hits":1,"x":280,"y":100},{"type":1,"hits":1,"x":280,"y":120},{"type":1,"hits":1,"x":280,"y":140},{"type":1,"hits":1,"x":280,"y":160},{"type":1,"hits":1,"x":280,"y":60},{"type":1,"hits":1,"x":320,"y":140},{"type":1,"hits":1,"x":280,"y":240},{"type":1,"hits":1,"x":320,"y":200},{"type":1,"hits":1,"x":280,"y":200},{"type":1,"hits":1,"x":320,"y":220},{"type":1,"hits":1,"x":320,"y":240},{"type":1,"hits":1,"x":320,"y":260},{"type":1,"hits":1,"x":320,"y":280},{"type":1,"hits":1,"x":280,"y":280},{"type":1,"hits":1,"x":320,"y":300},{"type":1,"hits":1,"x":280,"y":300},{"type":1,"hits":1,"x":320,"y":180},{"type":1,"hits":1,"x":320,"y":160},{"type":1,"hits":1,"x":320,"y":120},{"type":1,"hits":1,"x":320,"y":100},{"type":1,"hits":1,"x":320,"y":80},{"type":1,"hits":1,"x":320,"y":60},{"type":1,"hits":1,"x":320,"y":40},{"type":1,"hits":1,"x":320,"y":20},{"type":1,"hits":1,"x":320,"y":0},{"type":1,"hits":1,"x":360,"y":0},{"type":1,"hits":1,"x":360,"y":20},{"type":1,"hits":1,"x":360,"y":60},{"type":1,"hits":1,"x":360,"y":80},{"type":1,"hits":1,"x":360,"y":100},{"type":1,"hits":1,"x":360,"y":160},{"type":1,"hits":1,"x":360,"y":220},{"type":1,"hits":1,"x":360,"y":260},{"type":1,"hits":1,"x":360,"y":300},{"type":1,"hits":1,"x":360,"y":280},{"type":1,"hits":1,"x":360,"y":240},{"type":1,"hits":1,"x":360,"y":200},{"type":1,"hits":1,"x":360,"y":180},{"type":1,"hits":1,"x":360,"y":120},{"type":1,"hits":1,"x":360,"y":140},{"type":1,"hits":1,"x":360,"y":40},{"type":1,"hits":1,"x":400,"y":0},{"type":1,"hits":1,"x":400,"y":20},{"type":1,"hits":1,"x":440,"y":60},{"type":1,"hits":1,"x":440,"y":80},{"type":1,"hits":1,"x":400,"y":100},{"type":1,"hits":1,"x":400,"y":140},{"type":1,"hits":1,"x":400,"y":200},{"type":1,"hits":1,"x":400,"y":240},{"type":1,"hits":1,"x":400,"y":280},{"type":1,"hits":1,"x":400,"y":300},{"type":1,"hits":1,"x":400,"y":260},{"type":1,"hits":1,"x":400,"y":220},{"type":1,"hits":1,"x":400,"y":180},{"type":1,"hits":1,"x":400,"y":160},{"type":1,"hits":1,"x":400,"y":120},{"type":1,"hits":1,"x":400,"y":80},{"type":1,"hits":1,"x":400,"y":60},{"type":1,"hits":1,"x":400,"y":40},{"type":1,"hits":1,"x":440,"y":0},{"type":1,"hits":1,"x":440,"y":20},{"type":1,"hits":1,"x":440,"y":40},{"type":1,"hits":1,"x":440,"y":100},{"type":1,"hits":1,"x":440,"y":140},{"type":1,"hits":1,"x":440,"y":180},{"type":1,"hits":1,"x":440,"y":240},{"type":1,"hits":1,"x":440,"y":280},{"type":1,"hits":1,"x":440,"y":300},{"type":1,"hits":1,"x":440,"y":260},{"type":1,"hits":1,"x":440,"y":220},{"type":1,"hits":1,"x":440,"y":200},{"type":1,"hits":1,"x":440,"y":160},{"type":1,"hits":1,"x":440,"y":120},{"type":1,"hits":1,"x":480,"y":0},{"type":1,"hits":1,"x":520,"y":0},{"type":1,"hits":1,"x":560,"y":0},{"type":1,"hits":1,"x":560,"y":40},{"type":1,"hits":1,"x":560,"y":80},{"type":1,"hits":1,"x":520,"y":160},{"type":1,"hits":1,"x":560,"y":180},{"type":1,"hits":1,"x":560,"y":220},{"type":1,"hits":1,"x":560,"y":260},{"type":1,"hits":1,"x":560,"y":280},{"type":1,"hits":1,"x":560,"y":300},{"type":1,"hits":1,"x":480,"y":300},{"type":1,"hits":1,"x":520,"y":300},{"type":1,"hits":1,"x":520,"y":280},{"type":1,"hits":1,"x":480,"y":280},{"type":1,"hits":1,"x":480,"y":240},{"type":1,"hits":1,"x":480,"y":220},{"type":1,"hits":1,"x":480,"y":200},{"type":1,"hits":1,"x":480,"y":180},{"type":1,"hits":1,"x":480,"y":140},{"type":1,"hits":1,"x":480,"y":120},{"type":1,"hits":1,"x":480,"y":100},{"type":1,"hits":1,"x":480,"y":60},{"type":1,"hits":1,"x":480,"y":40},{"type":1,"hits":1,"x":480,"y":20},{"type":1,"hits":1,"x":560,"y":20},{"type":1,"hits":1,"x":520,"y":20},{"type":1,"hits":1,"x":520,"y":60},{"type":1,"hits":1,"x":560,"y":60},{"type":1,"hits":1,"x":520,"y":40},{"type":1,"hits":1,"x":520,"y":80},{"type":1,"hits":1,"x":480,"y":80},{"type":1,"hits":1,"x":520,"y":100},{"type":1,"hits":1,"x":560,"y":100},{"type":1,"hits":1,"x":560,"y":140},{"type":1,"hits":1,"x":520,"y":140},{"type":1,"hits":1,"x":520,"y":120},{"type":1,"hits":1,"x":560,"y":120},{"type":1,"hits":1,"x":560,"y":160},{"type":1,"hits":1,"x":520,"y":180},{"type":1,"hits":1,"x":520,"y":200},{"type":1,"hits":1,"x":560,"y":240},{"type":1,"hits":1,"x":560,"y":200},{"type":1,"hits":1,"x":520,"y":220},{"type":1,"hits":1,"x":520,"y":240},{"type":1,"hits":1,"x":520,"y":260},{"type":1,"hits":1,"x":480,"y":260},{"type":1,"hits":1,"x":480,"y":160}]}]

var levels = [levelOne];

//	These are just the default values incase the array does not load for some reason
var ballRad = 8;
var launched = false;

var levelDimensions = [];
//	The fields are as follows:
//	canvasWidth
//	camvasHeight
//	blockWidth
//	blockHeight
//	paddleWidth
//	paddleHeight
//	paddleSpeed
//	ballXV
//	ballYV
var blocks = [];
var levelName = "";

var timer;

//	levelDimension variables should be moved the these objects which are
//	currently unsed.
var paddle = {"xv": 0};
var ball = {"xv": 0, "yv": 0};
var shouldLoadLevel = true;
var context;

document.onkeydown = kvent;

function kvent(evt)
{
	if(evt.keyCode == '37')
	{
		console.log("left arrow");
		paddle.xv -= levelDimensions[6];
	}

	if(evt.keyCode == '39')
	{
		console.log("right arrow");
		paddle.xv += levelDimensions[6];
	}

	if(evt.keyCode == "32")
	{
		console.log("Launching the ball");
		launched = true;
	}
}

function renderRect(x, y, width, height, str)
{
	context.beginPath();
	context.rect(x, y, width, height);
	context.fillStyle = str;
	context.fill();
	context.closePath();
}

function renderType(x, y, n)
{
	if(n == 1)
	{
		renderRect(x, y, levelDimensions[2], levelDimensions[3], "#FF0000");
		renderRect(x + 4, y + 4, levelDimensions[2] - 8, levelDimensions[3] - 8, "#880000");
	}

	if(n == 2)
	{
		renderRect(x, y, levelDimensions[2], levelDimensions[3], "#00FF00");
		renderRect(x + 4, y + 4, levelDimensions[2] - 8, levelDimensions[3] - 8, "#008800");
	}

	if(n == 3)
	{
		renderRect(x, y, levelDimensions[2], levelDimensions[3], "#0000FF");
		renderRect(x + 4, y + 4, levelDimensions[2] - 8, levelDimensions[3] - 8, "#000088");
	}
}

function renderCircle(x, y, rad, color, border)
{
	context.beginPath();
	context.arc(x, y, rad, 0, Math.PI * 2);
	context.fillStyle = color;
	context.fill();

	if(border)
	{
		context.stroke();
	}
}

function render()
{
	fillScreen("#FFFFFF");

	renderRect(paddle.x, paddle.y, levelDimensions[4], levelDimensions[5], "#0000FF");
	renderRect(paddle.x + (levelDimensions[4] / 6), paddle.y + (levelDimensions[5] / 4), levelDimensions[4] - (levelDimensions[4] / 3), levelDimensions[5] - (levelDimensions[5] / 2), "#000066");

	renderCircle(ball.x, ball.y, ballRad, "#FFFF00", true);
	renderCircle(ball.x, ball.y, ballRad * .75, "#CCCC00", false);

	//console.log(typeof(blocks));
	for(var i = 0; i < blocks.length; ++i)
	{
		renderType(blocks[i].x, blocks[i].y, blocks[i].type);
	}
}

function collisionRectWall(x, y, w, h)
{
	if(x < 0 || y + h < 0 || x + w > levelDimensions[0] || y + h > levelDimensions[1])
	{
		return true;
	}

	return false;
}

//	Should give credit to:
//	https://stackoverflow.com/questions/21089959/detecting-collision-of-rectangle-with-circle
function collisionCircleRect(circleX, circleY, circleRad, rectX, rectY, rectW, rectH)
{
	//	Logically, this is actually checking if the ball is NOT colliding with
	//	rectangle and return the negation of that function.

	var xDist = Math.abs(circleX - rectX - rectW / 2);
	var yDist = Math.abs(circleY - rectY - rectH / 2);

	if(xDist > (rectW / 2 + circleRad) || yDist > (rectH / 2 + circleRad))
	{
		return false;
	}

	return true;
}

//	Horizontal reflection of the circle against a rectangle
function hCollisionCircleRectangle(circleX, circleY, circleRad, rectX, rectY, rectW, rectH)
{
	//	Logically, this is actually checking if the ball is NOT colliding with
	//	rectangle and return the negation of that function.

	if(!collisionCircleRect(ball.x, ball.y, ballRad, rectX, rectY, levelDimensions[2], levelDimensions[3]))
	{
		if(circleX + circleRad < rectX || circleX + circleRad > rectX + rectW)
		{
			return true;
		}
	}

	return false;
}

//	Vertical reflection of the circle against a rectangle
function vCollisionCircleRectangle(circleX, circleY, circleRad, rectX, rectY, rectW, rectH)
{
	//	Logically, this is actually checking if the ball is NOT colliding with
	//	rectangle and return the negation of that function.

	if(!collisionCircleRect(ball.x, ball.y, ballRad, rectX, rectY, levelDimensions[2], levelDimensions[3]))
	{
		if(circleY + circleRad < rectY || circleY - circleRad > rectY + rectH)
		{
			return true;
		}
	}

	return false;
}

//	Horizontal collision between the ball and the wall
function hCollisionCircleWall(circleX, circleRad, max)
{

	if(circleX - circleRad <= 0 || circleX + circleRad >= max)
	{
		return true;
	}

	return false;
}

//	Vertical collision between the ball and the wall
function vCollisionCircleWall(circleY, circleRad)
{
	if(circleY - circleRad <= 0)
	{
		return true;
	}

	return false;
}

function move()
{
	//	This causes choppiness when the paddle is close to the wall
	if(!collisionRectWall(paddle.x, paddle.y, levelDimensions[4], levelDimensions[5]) &&
		!collisionRectWall(paddle.x + paddle.xv, paddle.y, levelDimensions[4], levelDimensions[5]))
	{
		paddle.x += paddle.xv;

		if(!launched)
		{
			ball.x += paddle.xv;
		}
	}

	else
	{
		paddle.xv = 0;
	}

	if(launched)
	{
		if(hCollisionCircleWall(ball.x, ballRad, levelDimensions[0]))
		{
			levelDimensions[7] = -levelDimensions[7];
		}

		if(vCollisionCircleWall(ball.y, ballRad))
		{
			levelDimensions[8] = -levelDimensions[8];
		}

		for(var i = 0; i < blocks.length; ++i)
		{
			if(hCollisionCircleRectangle(ball.x, ballRad, blocks[i].x, levelDimensions[2]))
			{
				levelDimensions[7] = -levelDimensions[7];
			}

			//if(vCollisionCircleRectangle(ball.y, ballRad, blocks[i].y, levelDimensions[3]))
			if(vCollisionCircleRectangle(ball.x, ball.y, ballRad, blocks[i].x, blocks[i].y, levelDimensions[3], levelDimensions[3]))
			{
				levelDimensions[8] = -levelDimensions[8];
			}

			if(collisionCircleRect(ball.x, ball.y, ballRad, blocks[i].x, blocks[i].y, levelDimensions[2], levelDimensions[3]))
			{
			}
		}

		if(collisionCircleRect(ball.x, ball.y, ballRad, paddle.x, paddle.y, levelDimensions[2], levelDimensions[3]))
		{
			levelDimensions[7] = -levelDimensions[7];
		}

		if(collisionCircleRect(ball.x, ball.y, ballRad, paddle.x, paddle.y, levelDimensions[2], levelDimensions[3]))
		{
			levelDimensions[8] = -levelDimensions[8];
		}

		ball.x += levelDimensions[7];
		ball.y -= levelDimensions[8];
	}
}

function main()
{
	render();
	move();

	//	Pull information from the level array
	if(shouldLoadLevel)
	{
		var level = levels[0];

		//	Level dimensions
		levelDimensions.push(600);
		levelDimensions.push(600);
		levelDimensions.push(level[0]["dimensions"][2]);
		levelDimensions.push(level[0]["dimensions"][3]);
		levelDimensions.push(level[0]["dimensions"][4]);
		levelDimensions.push(level[0]["dimensions"][5]);
		levelDimensions.push(level[0]["dimensions"][6]);
		levelDimensions.push(level[0]["dimensions"][7]);
		levelDimensions.push(level[0]["dimensions"][8]);

		//	Now pull the blocks from the level data as well
		for(var i = 0; i < levelOne[1].blocks.length; ++i)
		{
			console.log("Loading the blocks");
			var block = {};
			block.type = levelOne[1].blocks[i].type;
			block.hits = levelOne[1].blocks[i].hits;
			block.x = levelOne[1].blocks[i].x;
			block.y = levelOne[1].blocks[i].y;

			blocks.push(block);
		}

		//	Set up objects to move around
		paddle.x = ((levelDimensions[0] / 2) - (levelDimensions[4] / 2));
		paddle.y = levelDimensions[1] - (levelDimensions[5]);
		ball.x = (levelDimensions[0] / 2);
		ball.y = levelDimensions[1] - ballRad - levelDimensions[5] -2;

		shouldLoadLevel = false;
	}
}

function createContext()
{
	var canvas = document.getElementById("main.focus.canvas");
	return canvas.getContext("2d");
}

function fillScreen(str)
{
	var context = createContext();
	context.rect(0, 0, levelDimensions[0], levelDimensions[1]);
	context.fillStyle = str;
	context.fill();
}

function blockTypeOne(x, y)
{
	var block;
	block.x = x;
	block.y = y;
	block.width = 20;
	block.height = 10;

	return block;
}

window.onload = function(){
	console.log("Javascript file loaded correctly");
	fillScreen("#ffffff");
	context = document.getElementById("main.focus.canvas").getContext("2d");

	timer = setInterval(main, 50);
};
